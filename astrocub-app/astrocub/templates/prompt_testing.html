<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Testing Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.4.12/src-min/ace.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">Prompt Testing Interface</h1>
            <p class="text-gray-600">Test and manage prompts for earnings call analysis</p>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Panel - Prompt Management -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Prompt Management</h2>
                
                <!-- Prompt Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Prompt</label>
                    <select id="promptSelect" class="w-full border rounded-md p-2">
                        {% for prompt in prompts %}
                        <option value="{{ prompt.name }}">{{ prompt.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Prompt Editor -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Edit Prompt</label>
                    <div id="promptEditor" class="w-full h-64 border rounded-md"></div>
                </div>

                <!-- Prompt Metadata -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="promptCategory" class="w-full border rounded-md p-2">
                            <option value="extraction">Extraction</option>
                            <option value="summarization">Summarization</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="promptStatus" class="w-full border rounded-md p-2">
                            <option value="active">Active</option>
                            <option value="draft">Draft</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                </div>

                <!-- Save Button -->
                <button id="savePrompt" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Save Prompt
                </button>
            </div>

            <!-- Right Panel - Testing -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Test Prompt</h2>
                
                <!-- Input Editor -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Test Input</label>
                    <div id="inputEditor" class="w-full h-64 border rounded-md"></div>
                </div>

                <!-- Test Controls -->
                <div class="flex space-x-4 mb-6">
                    <button id="testPrompt" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Run Test
                    </button>
                    <button id="clearResults" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                        Clear Results
                    </button>
                </div>

                <!-- Results Display -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Results</label>
                    <div id="resultsDisplay" class="w-full h-64 border rounded-md p-4 overflow-auto bg-gray-50">
                        <pre id="resultsContent" class="text-sm"></pre>
                    </div>
                </div>

                <!-- Processing Time -->
                <div id="processingTime" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize ACE editors
        const promptEditor = ace.edit("promptEditor");
        promptEditor.setTheme("ace/theme/monokai");
        promptEditor.getSession().setMode("ace/mode/json");

        const inputEditor = ace.edit("inputEditor");
        inputEditor.setTheme("ace/theme/monokai");
        inputEditor.getSession().setMode("ace/mode/text");

        // Load prompt data
        async function loadPrompt(promptName) {
            try {
                const response = await fetch(`/genetl/api/prompt/${promptName}`);
                const promptData = await response.json();
                
                promptEditor.setValue(JSON.stringify(promptData, null, 2));
                document.getElementById('promptCategory').value = promptData.category;
                document.getElementById('promptStatus').value = promptData.status;
            } catch (error) {
                console.error('Error loading prompt:', error);
            }
        }

        // Save prompt
        document.getElementById('savePrompt').addEventListener('click', async () => {
            try {
                const promptData = JSON.parse(promptEditor.getValue());
                promptData.category = document.getElementById('promptCategory').value;
                promptData.status = document.getElementById('promptStatus').value;
                
                const response = await fetch('/genetl/api/prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(promptData)
                });
                
                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }
                
                alert('Prompt saved successfully!');
            } catch (error) {
                alert('Error saving prompt: ' + error.message);
            }
        });

        // Test prompt
        document.getElementById('testPrompt').addEventListener('click', async () => {
            try {
                const promptName = document.getElementById('promptSelect').value;
                const testInput = inputEditor.getValue();
                
                document.getElementById('resultsContent').textContent = 'Processing...';
                
                const response = await fetch('/api/test-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt_name: promptName,
                        test_input: testInput
                    })
                });
                
                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }
                
                document.getElementById('resultsContent').textContent = 
                    JSON.stringify(result.result, null, 2);
                document.getElementById('processingTime').textContent = 
                    `Processing time: ${result.processing_time.toFixed(2)}s`;
            } catch (error) {
                document.getElementById('resultsContent').textContent = 
                    'Error: ' + error.message;
            }
        });

        // Clear results
        document.getElementById('clearResults').addEventListener('click', () => {
            document.getElementById('resultsContent').textContent = '';
            document.getElementById('processingTime').textContent = '';
        });

        // Load initial prompt
        document.getElementById('promptSelect').addEventListener('change', (e) => {
            loadPrompt(e.target.value);
        });

        // Load initial prompt on page load
        loadPrompt(document.getElementById('promptSelect').value);
    </script>
</body>
</html>